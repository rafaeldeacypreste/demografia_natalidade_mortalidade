---
title: "TRABALHO 1 - Estrutura populacional e projeções"
subtitle: "Demografia 1.2022 - Professora Ana Maria Nogales"
author: 
  - "Gabriel Peixoto Veiga^[Matrícula: 180016946]"
  - "João Victor Maia^[Matrícula: 221036824]"
  - "Marco Aurélio^[Matrícula: 160135702]"
  - "Rafael de Acypreste^[Matrícula: 200060023]"
date: "`r format(Sys.Date(),'%d/%m/%Y')`"
output:
  bookdown::html_document2:
    df_print: paged
    fig_caption: true
    number_sections: no
    theme: united
    toc: no
    toc_float:
      collapsed: yes
      smooth_scroll: yes
  bookdown::pdf_document2:  
    citation_package: natbib
    fig_caption: true
    number_sections: true
    toc_depth: 4
    latex_engine: xelatex
  bookdown::word_document2: default
fontsize: 12pt
linkcolor: blue
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{amsmath}
  - \usepackage{float}
  - \setlength{\parindent}{4em}
  - \setlength{\parskip}{1.5em}
  - \usepackage{titling}
  - \pretitle{\begin{center}
  - \posttitle{\end{center}}
bibliography: library_html.bib
biblio-style: "apalike"
link-citations: true
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  echo    = FALSE,                 # Mostra os códigos automaticamente
  eval    = TRUE,                  # se quiser rodar o código R - colocar TRUE
  fig.cap = 'Elaboração própria.', # Legenda automática de figuras
  fig.pos = 'H'
)

```

```{r logo, echo=FALSE}
htmltools::img(src = knitr::image_uri(file.path(getwd(), "as_vert_cor.jpg")), 
               alt = 'logo', 
               style = 'position:absolute; top:18px; right:50px; padding:20px; height: 10em;')
```


# {#inic .tabset}


```{r}
if (!require("pacman")) install.packages("pacman")

if (!require("microdatasus")) {
  pacman::p_load("remotes")
  remotes::install_github("rfsaldanha/microdatasus")
}

pacman::p_load("microdatasus", ## Download dos dados de 2000 a 2020
               "tidyverse",    ## Pacote de utilidades para manipulação e visualização
               "kableExtra",   ## Elaboração das tabelas em LaTeX e html
               "lubridate",
               "readxl",
               "LexisPlotR",   ## Pacote para Diagramas de Lexix
               "data.table",  
               "scales",
               janitor,
               fdth)


options(scipen = 99)
```



## Parte 1: Estrutura Populacional e avaliação da informação sobre idade



## Parte 2: Projeção de População

> **a)** *Os textos-base para responder a questão são @IBGE2021 e @IBGE2018 sobre as metodologias de estimação populacional.*

> *1) Metodologia utilizada para projetar a população do país segundo UF.*


Nota-se que o IBGE divulga desde 1973 as projeções populacionais pelo método das componentes principais. Além disso, desde 1975, divulga as projeções para Estados e Municípios durante os períodos intercensitários [@IBGE2018]. Ademais, sob qualquer sinal de de que estejam se distanciando do cenário real, as projeções devem ser revistas. Essas revisões também ocorrem após a realização de censos ou processos de contagem populacional.

As **projeções populacionais segundo a UF** em 2018 foram realizadas com o *software* do Departamento de Censo dos Estados Unidos (*Census Bureau*) denominado *US Census Bureau Rural and Urban Projection Program - RUP* [@IBGE2018].

O método utilizado foi o **método das componentes demográficas**. Para ser aplicado, é preciso partir de uma estrutura populacional já conhecida. Além disso, são necessárias informações confiáveis de fecundidade, mortalidade e migração. Com isso, são calculadas as interações entre essas três componentes seguindo as coortes ao longo do tempo. Avaliar tais interações é a parte mais delicada do processo, pois demanda acurácia nas projeções a respeito do futuro das taxas de fecundidade, mortalidade e migração de uma população [@IBGE2018]. 

Além de serem base para a formulação de diversas políticas públicas nos âmbitos naciona e regional, servem de base para estimar a população dos Municípios.



> *2) Metodologia para estimar populações dos municípios brasileiros.*

Como os munípios não apresentam as informações em nível de confiabilidade e detalhamento necessários para a aplicação do método das componentes demográficas, outra metodologia é necessária. O @IBGE2021 utiliza uma metodologia proposta por @madeira1972. 

Em síntese, observa-se a tendência de crescimento populacional do Município entre dois censos consecutivos. Em seguida, compara-se à tendência de crescimento de uma área geográfica hierarquicamente superior @IBGE2021 com dados de maior qualidade. Assim, essa área superior é dividida de modo que a soma das estimativas das suas sub-regiões iguale a projeção para a região base. Para o caso da estimativa 2021 para os Municípios, foram adotadas as projeções por UF referidas acima.


> **b)** *Assumindo população fechada (ausência de migração), projete a população da UF escolhida de 2010 a 2020, segundo o cenário de mortalidade e fecundidade do período 2010-2015 e 2015-2020. Considere os indicadores de mortalidade e fecundidade obtidos no Trabalho 1 e os publicados no portal do Datasus.*


A estimativa populacional partirá dos dados disponibilizados pelas projeções elaboradas pelo próprio IBGE e disponíveis [aqui](https://www.ibge.gov.br/estatisticas/sociais/populacao/9109-projecao-da-populacao.html?=&t=resultados). Trata-se da revisão de 2018, que utilizou os dados do Censo Demográfico de 2010 como base [@IBGE2018].

```{r}
  # Repositório do IBGE para a tabela .xls
file <-
  "https://ftp.ibge.gov.br/Projecao_da_Populacao/Projecao_da_Populacao_2018/projecoes_2018_populacao_2010_2060_20200406.xls"

  # Arquivo temporário para download da tabela
temp_pop <- tempfile()

  # Download da tabela em formato compatível com Windows
download.file(url      = file,
              destfile =  temp_pop,
              mode     = "wb")

  # Faixas etárias divulgadas pelo IBGE
faixas_etarias_IBGE <-
  read_xls(temp_pop,               # Arquivo temporário com a tabela de projeções
           sheet = "PE",           # Aba de Pernambuco
           range = "A7:A25",       # Células com a informação de interesse
           col_names = FALSE) %>%  # Sem nomes das colunas 
  pull()                           # Extrai as informações como um vetor

  # Lenvantamento da população masculina
pop_masc_2010 <-
  read_xls(temp_pop,
           sheet = "PE",
           range = "B7:B25",
           col_names = "Pop_masc") %>%
  pull()

  # Lenvantamento da população feminina
pop_fem_2010 <-
  read_xls(temp_pop,
           sheet = "PE",
           range = "B30:B48",
           col_names = "Pop_fem") %>%
  pull()

  # Lenvantamento da população total
pop_tot_2010 <-
  read_xls(temp_pop,
           sheet = "PE",
           range = "B53:B71",
           col_names = "Pop_tot") %>%
  pull()


pop_sex_ida_2010 <-
  tibble(
    "Idade_inicial" = faixas_etarias_IBGE,
    "Pop_masc_2010" = pop_masc_2010,
    "Pop_fem_2010"  = pop_fem_2010,
    "Pop_tot_2010"  = pop_tot_2010
  )

pop_sex_ida_2010_ajustada <- 
pop_sex_ida_2010 %>% 
  pivot_longer(cols = contains("Pop"),
               values_to = "Pop",
               names_to  = "Type") %>% 
  pivot_wider(names_from = Idade_inicial,
              values_from = Pop) %>% 
  rowwise() %>% # para somar nas linhas (caso contrário, resultado igual para todos)
  mutate("80+" = sum(c_across(`80-84`:`90+`))) %>% 
  select(-`80-84`, -`85-89`, -`90+`) %>% 
  pivot_longer(cols      = `0-4`:last_col(),
               names_to  = "Faixa_idade",
               values_to = "Pop") %>% 
  pivot_wider(names_from = Type,
              values_from = Pop)
```


Para o primeiro período de 2010 e 2015, utilizou-se a tábua de vida de 2013 elaborada pelo próprio IBGE e disponível [aqui](https://www.ibge.gov.br/estatisticas/sociais/populacao/9109-projecao-da-populacao.html?=&t=resultados). Já para a projeção da população sobrevivente entre 2015 e 2020, foram utilizados os dados do [trabalho 1](https://rpubs.com/rafaeldeacypreste/analise-demografica-pernambuco), conforme orientação da professora.


```{r}
  # 1) Tábua de vida IBGE

  # Repositório do IBGE para a tabela .xls
file <-
  "https://ftp.ibge.gov.br/Projecao_da_Populacao/Projecao_da_Populacao_2018/Tabuas_Mortalidade%202010-2060.xls"

  # Arquivo temporário para download da tabela
temp_tabua_vida <- tempfile()

  # Download da tabela em formato compatível com Windows
download.file(url      = file,
              destfile = temp_tabua_vida,
              mode     = "wb")

tabua_IBGE_masc <-  
read_xls(temp_tabua_vida,         # Arquivo temporário com a tabela de projeções
         sheet = "PE",            # Aba de Pernambuco
         range = "A84:I105") %>%  # Células com a informação de interesse) %>%
         drop_na() %>%
           select(Idade, nLx) %>% 
           pivot_wider(names_from  = Idade,
                       values_from = nLx) %>% 
           mutate(
             "75+" = sum(c_across(`75`:`90+`)),
             "80+" = sum(c_across(`80`:`90+`)),
             "0"   = sum(c_across(`0`:`1`))
           ) %>%
           select(-`1`, -`80`,-`85`,-`90+`) %>% 
           pivot_longer(cols      = `0`:last_col(),
                        names_to  = "Idade",
                        values_to = "nLx") %>% 
  mutate(prop_sobrev_IBGE_masc = nLx / lag(nLx, default = 500000)) %>% 
  filter(Idade != "75+")
         


tabua_IBGE_fem <-   
read_xls(temp_tabua_vida,         # Arquivo temporário com a tabela de projeções
         sheet = "PE",            # Aba de Pernambuco
         range = "K84:S105") %>%  # Células com a informação de interesse) %>%
         drop_na() %>%
           select(Idade, nLx) %>% 
           pivot_wider(names_from  = Idade,
                       values_from = nLx) %>% 
           mutate(
             "75+" = sum(c_across(`75`:`90+`)),
             "80+" = sum(c_across(`80`:`90+`)),
             "0"   = sum(c_across(`0`:`1`))
           ) %>%
           select(-`1`, -`80`,-`85`,-`90+`) %>% 
           pivot_longer(cols      = `0`:last_col(),
                        names_to  = "Idade",
                        values_to = "nLx") %>% 
  mutate(prop_sobrev_IBGE_fem = nLx / lag(nLx, default = 500000)) %>% 
  filter(Idade != "75+")


#----------------------------------------------------------------------

  # 2) Tábua de vida trabalho 1

tabua_trab1_masc <- 
read_xlsx("TabuasVida.xlsx", 
          sheet = "TV Masc", 
          range = "A1:H19") %>%
  select(x, nLx) %>%
  pivot_wider(names_from  = x,
              values_from = nLx) %>% 
  rename("80+" = `80`) %>% 
  mutate(
    "0"   = sum(c_across(`0`:`1`)),
    "75+" = sum(c_across(`75`:`80+`))) %>%  
  select(-`1`) %>% 
  select(`0`:`75`, `75+`, `80+`) %>% 
  pivot_longer(cols      = `0`:last_col(),
               names_to  = "Idade",
               values_to = "nLx") %>% 
  mutate(prop_sobrev_trab1_masc = nLx / lag(nLx, default = 500000)) %>% 
  filter(Idade != "75+")

  # Tábua feminina
tabua_trab1_fem <- 
read_xlsx("TabuasVida.xlsx", 
          sheet = "TV Fem", 
          range = "A1:H19") %>%
  select(x, nLx) %>%
  pivot_wider(names_from  = x,
              values_from = nLx) %>% 
  rename("80+" = `80`) %>% 
  mutate(
    "0"   = sum(c_across(`0`:`1`)),
    "75+" = sum(c_across(`75`:`80+`))) %>%  
  select(-`1`) %>% 
  select(`0`:`75`, `75+`, `80+`) %>% 
  pivot_longer(cols      = `0`:last_col(),
               names_to  = "Idade",
               values_to = "nLx") %>% 
  mutate(prop_sobrev_trab1_fem = nLx / lag(nLx, default = 500000)) %>% 
  filter(Idade != "75+")


```

Para os nascimentos, foram utilizadas as taxas específicas de fecundidade feminina com base nos dados do trabalho 1. Para o período de 2010 a 2015, utilizou-se as taxas calculadas conforme a média móvel de nascimentos centrada em 2015 (com dados de 2014 a 2016) e, para a projeção 2015-2020, utilizou-se as taxas calculadas conforme a média móvel de nascimentos centrada em 2020 (com dados de 2019 a 2021).

```{r}
  # População feminina em idade fértil em 2015
pop_fem_2015 <- 
  read_xls(temp_pop,
           sheet     = "PE",
           range     = "G30:G48",
           col_names = "Pop_fem") %>%
  pull()

pop_fem_2015_fertil <- 
  tibble(
    "Idade_inicial" = faixas_etarias_IBGE,
    "Pop_fem_2015"  = pop_fem_2015) %>% 
    filter(between(Idade_inicial, "10-14", "45-49"))


  # População feminina em idade fértil em 2020
pop_fem_2020 <- 
  read_xls(temp_pop,
           sheet = "PE",
           range = "L30:L48",
           col_names = "Pop_fem") %>%
  pull()

pop_fem_2020_fertil <- 
  tibble(
    "Idade_inicial" = faixas_etarias_IBGE,
    "Pop_fem_2020" = pop_fem_2020) %>% 
    filter(between(Idade_inicial, "10-14", "45-49"))
```


```{r, eval=FALSE}
 # Nascimentos vivos
  # Download dos microdados do datasus
dados_sinasc <- fetch_datasus(
  year_start         = 2000,
  year_end           = 2020,
  uf                 = "PE",
  information_system = "SINASC"
)

```


```{r, eval=FALSE}
  # Repositório Ministério da Saúde
file <- "https://svs.aids.gov.br/dantps/centrais-de-conteudos/dados-abertos/sinasc/DN21OPEN.zip"
  
  # Cria arquivo temporário para download do arquivo .zip
temp <- tempfile()
  
  # Download do arquivo
utils::download.file(file, temp, mode = "wb")


  # Cria pasta temporária para descompactar arquivo .zip
tempd <- tempdir()
  
  # Descompacta o arquivo
unzip(temp, exdir = tempd)


dados_sinasc_2021 <- foreign::read.dbf(str_c(tempd, "\\DNOPEN21.dbf")) %>%                 # Importa a tabela .dbf
  filter(str_detect(CODMUNRES, "^26")) # Filtra pessoas residentes apenas em PE

  # Remove arquivo e pasta temporárias
file.remove(temp)
unlink(tempd)

```


```{r, cache=TRUE}

# 2014 a 2016

  # Nascidos vivos por idade da mãe
nascidos_vivos_ate_2016 <- 
dados_sinasc %>%
  select(DTNASC, IDADEMAE) %>% # Seleciona as colunas de interesse
  mutate(# Transforma Data de óbito em .date
    DTNASC = str_sub(DTNASC,-4,-1)) %>% # Identifica o ano do nascimento
  filter(DTNASC %in% 2014:2016) %>% 
  mutate(IDADEMAE = as.numeric(IDADEMAE)) %>%
  group_by(DTNASC) %>%
  filter(between(IDADEMAE, 10, 49)) %>% # Menos que 10 anos deve ser erro de registro
  mutate(
    Faixa_etaria = cut(      # Divisão das faixas etárias
      IDADEMAE,              # Agrupa nas faixas
      breaks         = c(10, seq(
        from = 15, to = 50, by = 5
      )),                    # Períodos de quebra
      right          = FALSE,
      include.lowest = TRUE,
      labels         = faixas_etarias_IBGE[3:10]                                # Nomes dos intervalos etários
    )
  ) %>% 
  arrange(IDADEMAE) %>% 
  count(DTNASC, Faixa_etaria) %>%
  group_by(Faixa_etaria) %>%
  summarise(Nascimentos = round(mean(n)))

  # Tábua específica de fertilidade
nfx_2015 <- 
  nascidos_vivos_ate_2016 %>%
  left_join(pop_fem_2015_fertil, by = c("Faixa_etaria" = "Idade_inicial")) %>%
  mutate(nfx = Nascimentos / Pop_fem_2015) %>% 
  select("Faixa_idade" = Faixa_etaria, nfx)

#---------------------------------------------------------------
# 2019 a 2021

  # Nascidos vivos por idade da mãe
nascidos_vivos_ate_2020 <- 
dados_sinasc %>%
  select(DTNASC, IDADEMAE) %>% # Seleciona as colunas de interesse
  mutate(# Transforma Data de óbito em .date
    DTNASC = str_sub(DTNASC,-4,-1)) %>% # Identifica o ano do nascimento
  filter(DTNASC %in% c(2019, 2020))


nascidos_vivos_2021 <- 
  dados_sinasc_2021 %>%
  select(DTNASC, IDADEMAE) %>% 
  mutate(# Transforma Data de óbito em .date
    DTNASC = str_sub(DTNASC,-4,-1)) 
    
nascidos_vivos_ate_2021 <-  
  nascidos_vivos_ate_2020 %>%
  bind_rows(nascidos_vivos_2021) %>%
  mutate(IDADEMAE = as.numeric(IDADEMAE)) %>%
  group_by(DTNASC) %>%
  filter(between(IDADEMAE, 10, 49)) %>% # Menos que 10 anos deve ser erro de registro
  mutate(
    Faixa_etaria = cut(      # Divisão das faixas etárias
      IDADEMAE,              # Agrupa nas faixas
      breaks         = c(10, seq(
        from = 15, to = 50, by = 5
      )),                    # Períodos de quebra
      right          = FALSE,
      include.lowest = TRUE,
      labels         = faixas_etarias_IBGE[3:10]                                # Nomes dos intervalos etários
    )
  ) %>% 
  arrange(desc(IDADEMAE)) %>%
  count(DTNASC, Faixa_etaria) %>%
  group_by(Faixa_etaria) %>%
  summarise(Nascimentos = round(mean(n)))

nfx_2020 <-
  nascidos_vivos_ate_2021 %>%
  left_join(pop_fem_2020_fertil, by = c("Faixa_etaria" = "Idade_inicial")) %>%
  mutate(nfx = Nascimentos / Pop_fem_2020) %>% 
  select("Faixa_idade" = Faixa_etaria, nfx)

```



> Projeção da população para 2015 e para 2020

A partir das condições apresentadas, as projeções de população para os anos de 2015 e 2020 no Estado de Pernambuco são: 

```{r}
projecao_2015 <- 
pop_sex_ida_2010_ajustada %>% 
  bind_cols(select(tabua_IBGE_masc, prop_sobrev_IBGE_masc)) %>% 
  bind_cols(select(tabua_IBGE_fem, prop_sobrev_IBGE_fem)) %>% 
  mutate(Projecao_2015_masc = round(Pop_masc_2010 * prop_sobrev_IBGE_masc),
         Projecao_2015_fem = round(Pop_fem_2010 * prop_sobrev_IBGE_fem)) %>% 
  select(Faixa_idade, contains("Projecao")) %>% 
  pivot_longer(cols      = contains("Projecao"),
               values_to = "L_valor",
               names_to  = "Type") %>% 
  pivot_wider(names_from  = Faixa_idade,
              values_from = L_valor) %>% 
  mutate("75-79" = `75-79` + `80+`)  %>% 
  pivot_longer(cols      = `0-4`:last_col(),
                        names_to  = "Faixa_idade",
                        values_to = "Valor") %>%
           pivot_wider(names_from  = Type,
                       values_from = Valor)  %>% 
  mutate(Projecao_2015_masc = lag(Projecao_2015_masc),
         Projecao_2015_fem  = lag(Projecao_2015_fem)) 

  # Nascimentos no período
faixa_0_4_2015 <- 
pop_sex_ida_2010_ajustada %>% 
  left_join(nfx_2015) %>% 
  mutate(Nascimentos = Pop_fem_2010 * nfx) %>% 
  summarise(Nascimentos = 5 * round(sum(Nascimentos, na.rm = TRUE))) %>% 
  pull()

  # Inclui a razão de sexo
projecao_2015[1, "Projecao_2015_masc"] <- round(faixa_0_4_2015 * 105/205)
projecao_2015[1, "Projecao_2015_fem"] <- round(faixa_0_4_2015 * 100/205)


#----------------------------------------------------------

# Projeção 2020

projecao_2020 <- 
projecao_2015 %>% 
  bind_cols(select(tabua_trab1_masc, prop_sobrev_trab1_masc)) %>% 
  bind_cols(select(tabua_trab1_fem, prop_sobrev_trab1_fem)) %>% 
  mutate(Projecao_2020_masc = round(Projecao_2015_masc * prop_sobrev_trab1_masc),
         Projecao_2020_fem = round(Projecao_2015_fem * prop_sobrev_trab1_fem)) %>% 
  select(Faixa_idade, contains("Projecao_2020")) %>%   
  pivot_longer(cols      = contains("Projecao"),
               values_to = "L_valor",
               names_to  = "Type") %>% 
  pivot_wider(names_from  = Faixa_idade,
              values_from = L_valor) %>% 
  mutate("75-79" = `75-79` + `80+`)  %>% 
  pivot_longer(cols      = `0-4`:last_col(),
                        names_to  = "Faixa_idade",
                        values_to = "Valor") %>%
           pivot_wider(names_from  = Type,
                       values_from = Valor)  %>% 
  mutate(Projecao_2020_masc = lag(Projecao_2020_masc),
         Projecao_2020_fem  = lag(Projecao_2020_fem)) 

faixa_0_4_2020 <- 
projecao_2015 %>% 
  left_join(nfx_2020) %>% 
  mutate(Nascimentos = Projecao_2015_fem * nfx) %>% 
  summarise(Nascimentos = 5 * round(sum(Nascimentos, na.rm = TRUE))) %>% 
  pull()

  # Inclui a razão de sexo
projecao_2020[1, "Projecao_2020_masc"] <- round(faixa_0_4_2020 * 105/205)
projecao_2020[1, "Projecao_2020_fem"] <- round(faixa_0_4_2020 * 100/205)

projecoes <- 
pop_sex_ida_2010_ajustada %>%
  select(-Pop_tot_2010) %>%
  left_join(projecao_2015) %>%
  left_join(projecao_2020) %>%
  select(Faixa_idade, contains("fem"), everything())


  # Tabela para .html
projecoes %>% 
  kbl(
    format    = "html",
    align     = "c",
    digits    = 0,
    booktabs  = TRUE,
    col.names = c(
      "Faixa Etária",
      "População Feminina 2010",
      "População Feminina 2015 (projeção)",
      "População Masculina 2020 (projeção)",
      "População Masculina 2010",
      "População Masculina 2015 (projeção)",
      "População Feminina 2020 (projeção)"
    ),
    format.args = list(big.mark = ",")
  ) %>%
  footnote(
    general  = "Projeção populacional para o ano de 2010 (revisão 2018) e Tábua de vida elaboradas pelo IBGE . Dados do SINASC (Ministério da Saúde) para o cálculo das taxas específicas de fecundidade.  elaborada também pelo IBGE",
    general_title = "Nota: ",
    footnote_as_chunk = TRUE,
    threeparttable    = TRUE
  ) %>%
  kable_styling("striped")
```





### Referências