---
title: "TRABALHO 1 - Natalidade/Fecundidade e Mortalidade"
subtitle: "Demografia 1.2022 - Professora Ana Maria Nogales"
author: 
  - "Gabriel^[Matrícula:]"
  - "João Victor Maia^[Matrícula: 221036824]"
  - "Marco Aurélio^[Matrícula:]"
  - "Rafael de Acypreste^[Matrícula: 200060023]"
date: "`r format(Sys.Date(),'%d/%m/%Y')`"
output:
  bookdown::html_document2:
    df_print: paged
    fig_caption: true
    number_sections: no
    theme: lumen
    toc: no
    toc_float:
      collapsed: yes
      smooth_scroll: yes
  bookdown::pdf_document2:  
    citation_package: natbib
    fig_caption: true
    number_sections: true
    toc_depth: 4
    latex_engine: xelatex
  bookdown::word_document2: default
fontsize: 12pt
linkcolor: blue
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{amsmath}
  - \usepackage{float}
  - \setlength{\parindent}{4em}
  - \setlength{\parskip}{1.5em}
  - \usepackage{titling}
  - \pretitle{\begin{center}
    \includegraphics[width=1in,height=1in]{marca_unb_completa_horizontal.jpg}\LARGE\\}
  - \posttitle{\end{center}}
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  echo    = FALSE,                 # Mostra os códigos automaticamente
  eval    = TRUE,                  # se quiser rodar o código R - colocar TRUE
  fig.cap = 'Elaboração própria.', # Legenda automática de figuras
  fig.pos = 'H'
)

```


# {#inic .tabset}

## Introdução 



Neste documento, estão os explicados os procedimentos para as respostas ao Primeiro trabalho: `TRABALHO 1 - Natalidade/Fecundidade e Mortalidade`, cujo prazo de entrega é dia 15/08/2022. Os pacotes utilizados foram:

```{r}
if (!require("pacman")) install.packages("pacman")

if (!require("microdatasus")) {
  pacman::p_load("remotes")
  remotes::install_github("rfsaldanha/microdatasus")
}

pacman::p_load("microdatasus", ## Download dos dados de 2000 a 2020
               "tidyverse",    ## Pacote de utilidades para manipulação e visualização
               "kableExtra",   ## Elaboração das tabelas em LaTeX e html
               "lubridate",
               "readxl")

options(scipen = 99)
```


### Download dos dados


### Dados de Nascidos Vivos a partir do SINASC

#### Microdados DATASUS

Os microdados do SINASC de 2000 a 2020 foram baixados com a ajuda do pacote [`microdatasus`](https://github.com/rfsaldanha/microdatasus), criado por @. Os procedimentos de pré-processamento dos micradodos realizados podem ser encontrados em: https://github.com/rfsaldanha/microdatasus/wiki/Conven%C3%A7%C3%B5es-SINASC. Os dados para o Estado de Pernambuco podem ser baixados por

```{r}
  # Download dos microdados do datasus
dados_sinasc <- fetch_datasus(
  year_start         = 2000,
  year_end           = 2020,
  uf                 = "PE",
  information_system = "SINASC"
)
```


### Dados preliminares 2021

Para o ano de 2021, há apenas dados preliminares que podem ser tratados em:

```{r}
  # Repositório Ministério da Saúde
file <- "https://svs.aids.gov.br/dantps/centrais-de-conteudos/dados-abertos/sinasc/DN21OPEN.zip"
  
  # Cria arquivo temporário para download do arquivo .zip
temp <- tempfile()
  
  # Download do arquivo
utils::download.file(file, temp, mode = "wb")


  # Cria pasta temporária para descompactar arquivo .zip
tempd <- tempdir()
  
  # Descompacta o arquivo
unzip(temp, exdir = tempd)


dados_sinasc_2021 <- foreign::read.dbf(file.path(tempd, "DN21OPEN.dbf")) %>% # Importa a tabela .dbf
  filter(str_detect(CODMUNRES, "^26")) # Filtra pessoas residentes apenas em PE

  # Remove arquivo e pasta temporárias
file.remove(temp)
unlink(tempd)
```



#### Consolidação dos dados de nascidos vivos

Com isso, pode-se levantar os dados de nascimentos por ano e idade da mãe^[As células de idade vazias ou "99" indicam idade não definida.]:

```{r}

dados_sinasc %>% 
  mutate(DTNASC = str_sub(DTNASC, -4, -1)) %>% 
  count(DTNASC, IDADEMAE) 
```


### Dados de Nascidos Vivos a partir do SIM

Os microdados do SIM de 2000 a 2020 foram baixados com a ajuda do pacote [`microdatasus`](https://github.com/rfsaldanha/microdatasus), criado por @. As convenções adotadas no SIM podem ser encontradas em https://github.com/rfsaldanha/microdatasus/wiki/Conven%C3%A7%C3%B5es-SIM. Os dados para o Estado de Pernambuco podem ser baixados por

```{r}
dados_sim <- fetch_datasus(
  year_start         = 2000,
  year_end           = 2020,
  uf                 = "PE",
  information_system = "SIM-DO"
)
```



### Dados preliminares de óbitos (2021)


```{r}

  # Mesmo procedimento para os dados do SINASC
file <- "https://svs.aids.gov.br/dantps/centrais-de-conteudos/dados-abertos/sim/DO21OPEN.zip"
temp <- tempfile()
tempd <- tempdir()

utils::download.file(file, temp, mode = "wb")


unzip(temp, exdir = tempd)


dados_sim_2021 <-
  foreign::read.dbf(file.path(tempd, "DO21OPEN.dbf")) %>% # Importa a tabela .dbf
  filter(str_detect(CODMUNRES, "^26")) # Filtra pessoas residentes apenas em PE


file.remove(temp)
unlink(tempd)
```


Também precisamos dos dados de projeção populacional para o Estado de Pernambuco. Nesse caso, utilizamos as projeções elaboradas pelo próprio IBGE e disponíveis [aqui](https://www.ibge.gov.br/estatisticas/sociais/populacao/9109-projecao-da-populacao.html?=&t=resultados).

Com isso, tem-se as projeções populacionais por sexo e idade. Os dados de projeção populacional do IBGE podem ser acessados em: 

```{r}
  # Repositório do IBGE para a tabela .xls
file <-
  "https://ftp.ibge.gov.br/Projecao_da_Populacao/Projecao_da_Populacao_2018/projecoes_2018_populacao_idade_simples_2010_2060_20201209.xls"

  # Arquivo temporário para download da tabela
temp_pop <- tempfile()

  # Download da tabela em formato compatível com Windows
download.file(url      = file,
              destfile =  temp_pop,
              mode     = "wb")

```




## Questão 1: Diagrama de Lexis


## Questão 2: Natalidade/Fecundidade 

a) 


A partir da tabela de projeção, é possível acessar as projeções por sexo e idade.

```{r}
  # Faixas etárias divulgadas pelo IBGE
faixas_etarias_IBGE <-
  read_xls(temp_pop,               # Arquivo temporário com a tabela de projeções
           sheet = "PE",           # Aba de Pernambuco
           range = "A7:A96",       # Células com a informação de interesse
           col_names = FALSE) %>%  # Sem nomes das colunas 
  pull()                           # Extrai as informações como um vetor

faixas_etarias_IBGE <- c(faixas_etarias_IBGE, 90) # 90 como última idade inicial

  # Subdicisão da primeira faixa etária divulgadas pelo IBGE
faixas_etarias <-
  c(
    "< 1",
    "1-4",
    "5-9",
    "10-14",
    "15-19",
    "20-24",
    "25-29",
    "30-34",
    "35-39",
    "40-44",
    "45-49",
    "50-54",
    "55-59",
    "60-64",
    "65-69",
    "70-74",
    "75-79",
    "80-84",
    "85-89",
    "90+"
  )


  # Lenvantamento da população masculina
pop_masc_2020 <-
  read_xls(temp_pop,
           sheet = "PE",
           range = "L7:L97",
           col_names = "Pop_masc") %>%
  pull()

  # Lenvantamento da população feminina
pop_fem_2020 <-
  read_xls(temp_pop,
           sheet = "PE",
           range = "L103:L193",
           col_names = "Pop_fem") %>%
  pull()

  # Lenvantamento da população total
pop_tot_2020 <-
  read_xls(temp_pop,
           sheet = "PE",
           range = "L198:L288",
           col_names = "Pop_tot") %>%
  pull()

  # Ajuste de toda a população em idades simples
pop_sex_ida_2020 <-
  tibble(
    "Idade_inicial" = faixas_etarias_IBGE,
    "Pop_masc_2020" = pop_masc_2020,
    "Pop_fem_2020"  = pop_fem_2020,
    "Pop_tot_2020"  = pop_tot_2020
  )
  
  # Ajusta faixas etárias
pop_sex_ida_2020 <- 
  pop_sex_ida_2020 %>%
  mutate(
    Faixa_etaria = cut(      # Divisão das faixas etárias
      Idade_inicial,         # Agrupa nas faixas
      breaks         = c(0, 1, seq(from = 5, to = 90, by = 5), 120), # Períodos de quebra
      right          = FALSE,
      include.lowest = TRUE,
      labels         = faixas_etarias                                # Nomes dos intervalos etários
    )
  ) %>%
  select(Faixa_etaria, contains("2020")) %>% 
  group_by(Faixa_etaria) %>%                     # Soma o total dentro das faixas etárias
  summarise(Pop_masc_2020 = sum(Pop_masc_2020),
            Pop_fem_2020  = sum(Pop_fem_2020),
            Pop_tot_2020  = sum(Pop_tot_2020))
  
  # Visualiza os dados no arquivo .html
pop_sex_ida_2020
```



## Questão 3: Mortalidade


**a)** *Com base nos dados sobre óbitos do SIM para 2019 a 2021 e a população por sexo e idade estimada (projetada) em 2020 para a UF, obtenha os seguintes indicadores:*

Em primeiro lugar, deve-se acessar os dados conforme a seção introdutória.

>- Taxa Bruta de Mortalidade

  Taxa Bruta de Mortalidade diz respeito ao total do número de óbitos, por mil habitantes, na população residente no local e período de interesse. No presente exercício, avaliamos a taxa no Estado de Pernambuco, com o período centrado no ano de 2020.
  
O número de óbitos em 2020 contabilizado a partir da média móvel entre 2019 e 2021 por

```{r}
obitos_total_19_20 <- 
  dados_sim %>%
  select(DTOBITO, TIPOBITO) %>% # Seleciona as colunas de interesse
  filter(TIPOBITO == 2) %>%     # Seleciona óbitos não fetais
  mutate(# Transforma Data de óbito em .date
    DTOBITO = str_sub(DTOBITO,-4,-1)) %>% # Identifica o ano do óbito
  count(DTOBITO) %>%                      # Conta as linhas em cada ano
  filter(DTOBITO %in% c(2019, 2020)) %>%  # Filtra apenas o ano 2020
  pull(n)
 
obitos_total_21 <-
  dados_sim_2021 %>%
  select(DTOBITO, TIPOBITO) %>% # Seleciona as colunas de interesse
  filter(TIPOBITO == 2) %>%     # Seleciona óbitos não fetais
  summarise(n = n()) %>%        # Conta as linhas do ano de 2021
  pull(n) 
  

obitos_total_2020 <- mean(c(obitos_total_19_20, obitos_total_21))

obitos_total_2020
```

Já o dado de população pode ser consultado em 

```{r}
  # Identifica o valor da população total em 2020
pop_2020 <-
  read_xls(temp_pop,
           sheet = "PE",
           range = "L196:L197") %>% # Células com a informação
  pull()

```


Portando, a Taxa Bruta de Mortalidade por mil habitantes para o Estado de Pernambuco em 2020 foi `r round(obitos_total_2020 / pop_2020 * 1000, digits = 4)`.

>- Taxas específicas de mortalidade por sexo e idade - nMx (grafique)

As projeções populacionais por sexo e idade já foram coletadas na questão 2 e serão aproveitadas nesta.

Em seguida, pode-se contabilizar o número de óbitos por faixa etária no ano de 2020:

```{r}

obitos_sex_ida_2020 <- 
dados_sim %>%
  select(DTNASC, DTOBITO, "Sexo" = SEXO) %>% 
  mutate(# Transforma Data de óbito em .date
    Ano_obito = str_sub(DTOBITO, -4, -1)) %>%
  filter(Ano_obito == 2020, 
         Sexo %in% c(1, 2)) %>% # Seleciona a coluna de sexo para identificar entre masc e fem
  select(-Ano_obito) %>%        # Exclui coluna sem mais utilidade
  mutate(    # Transforma Data de nascimento em .date
    DTNASC = as.character(DTNASC),                                # Muda formato
    DTNASC = case_when(str_length(DTNASC) == 7 ~ str_c(0, DTNASC),# Insere 0 à esquerda para igualar
                       TRUE                    ~ DTNASC),         # todas as datas de nascimento
    DTNASC = parse_date(as.character(DTNASC), format = "%d%m%Y")  # Transforma em formato de data
  ) %>%
  mutate(    # Transforma Data de óbito em .date
    DTOBITO = as.character(DTOBITO),
    DTOBITO = case_when(str_length(DTOBITO) == 7 ~ str_c(0, DTOBITO),
                        TRUE                     ~ DTOBITO),
    DTOBITO = parse_date(as.character(DTOBITO), format = "%d%m%Y")
  ) %>%
  mutate(
    Tempo_de_vida = time_length(interval(DTNASC, DTOBITO), # Calula idade de óbito
                                "year"),                   # em anos
    Faixa_etaria = cut(                                    # A partir do tempo de vida
      Tempo_de_vida,                                       # divide em grupos
      breaks         = c(0, seq(from = 5, to = 90, by = 5), 120), # Períodos de quebra
      right          = FALSE,
      include.lowest = TRUE,
      labels         = faixas_etarias_IBGE                 # Nomes dos intervalos etários
    )
  )    %>% 
 drop_na() %>%   # Retuira casos com data de nascimento desconhecida
 count(Sexo, Faixa_etaria) %>%    # Conta os nascimentos por sexo e faixa etária
 pivot_wider(names_from = Sexo,   # Espalha as colunas do sexo
             values_from = n) %>% 
  rename("Obitos_masc" = `1`,     # Renomeia para nome objetivo
         "Obitos_fem" = `2`)



```


```{r}
  # Agora, as duas tabelas podem ser juntadas para contabilizar as taxas específicas 
nMx_PE_2020 <-
  obitos_sex_ida_2020 %>%          
  left_join(pop_sex_ida_2020) %>% # Junta população à tabela de óbitos
  select(-Pop_tot_2020) %>% 
  mutate( 
    "nMx Masc" = Obitos_masc / Pop_masc_2020, # Calcula os nMx
    "nMx Fem"  = Obitos_fem / Pop_fem_2020,
    Faixa_etaria = factor(                   # Transforma em factor para plotar
      Faixa_etaria,
      levels = c(
        "0-4",
        "5-9",
        "10-14",
        "15-19",
        "20-24",
        "25-29",
        "30-34",
        "35-39",
        "40-44",
        "45-49",
        "50-54",
        "55-59",
        "60-64",
        "65-69",
        "70-74",
        "75-79",
        "80-84",
        "85-89",
        "90+"
      )
    )
  )

nMx_PE_2020 %>%
  kbl(
    format    = "html",
    align     = "c", 
    digits    = 5,
    booktabs  = TRUE,
    col.names = c("Faixa Etária", "Óbitos Masculinos",
                  "Óbitos Femininos", "População Masculina",
                  "População Feminina", "nMx \n Masculina",
                  "nMx Feminina")) %>%
  footnote(
    general  = "Dados do SIM do Ministério da Saúde referentes ao ano de 2020.",
    footnote_as_chunk = TRUE,
    threeparttable    = TRUE
  ) %>%
  kable_styling("striped")
```

cujo gráfico pode ser visualizado em 

```{r}
  # Gráfico das nMx
nMx_PE_2020 %>%
  rename("Feminino"  = `nMx Fem`,   # Ajusta nomes que aparecerão na legenda
         "Masculino" = `nMx Masc`) %>% 
  select(Faixa_etaria, Masculino, Feminino) %>% # Informações a irem para o gráfico
  pivot_longer(
    cols = c(Masculino, Feminino),  # Formato longer para que sejam plotadas no mesmo gráfico
    values_to = "nMx",              # na legenda
    names_to  = "Categoria"
  ) %>%
  ggplot(aes(
    x     = Faixa_etaria,
    y     = nMx,
    group = Categoria,    # Usa o factor para entender a ordem das faixas etárias no eixo x
    color = Categoria     # Desenha uma curva para cada sexo
  )) +
  geom_line(size = 1.25) +
  scale_y_log10() +       # Escala de log para os valores de nMx
  theme_bw() +
  labs(x = "Faixa etária",
       color = NULL) +
  theme(
    axis.title.y = element_text(angle = 0, size = 12, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.ticks = element_line(color = "gray"),
    panel.grid.minor   = element_blank(),
    panel.grid.major.x = element_blank(),
    legend.position = "bottom"
  )
```


**b)** *Calcule a TMI, utilizando o número médio de óbitos ocorridos entre 2019 e 2021 e o número de nascimentos de 2020. Calcule os indicadores: taxa de mortalidade neonatal, neonatal precoce, neonatal tardia, posneonatal. Agregando a informação sobre óbitos fetais para os mesmos anos, calcule a taxa de mortalidade perinatal.*


```{r}
  # Cálculo da média de óbitos em 2019 e 2020 com procedimentos semelhantes já aplicados
obitos_infantis_2019_2020 <-
  dados_sim %>%
  select(DTNASC, TIPOBITO, DTOBITO, "Sexo" = SEXO) %>%
  mutate(
    Ano_obito = str_sub(DTOBITO,-4,-1)) %>%
  filter(Ano_obito %in% c(2019, 2020),
         Sexo %in% c(1, 2)) %>%
  mutate(
    DTNASC = as.character(DTNASC),
    DTNASC = case_when(str_length(DTNASC) == 7 ~ str_c(0, DTNASC),
                       TRUE                    ~ DTNASC),
    DTNASC = parse_date(as.character(DTNASC), format = "%d%m%Y")
  ) %>%
  mutate(
    DTOBITO = as.character(DTOBITO),
    DTOBITO = case_when(str_length(DTOBITO) == 7 ~ str_c(0, DTOBITO),
                        TRUE                     ~ DTOBITO),
    DTOBITO = parse_date(as.character(DTOBITO), format = "%d%m%Y")
  ) %>%
  mutate(Tempo_de_vida = time_length(interval(DTNASC, DTOBITO), # Caclula idade de óbito em dias 
                                     "days"))    %>%
  filter(Tempo_de_vida < 365) %>% # Mortes com menos de um ano
  drop_na()                       # Exclui Data de nascimento desconhecida


  # Cálculo da média de óbitos em 2021
obitos_infantis_2021 <-  
  dados_sim_2021 %>%
  select(DTNASC, TIPOBITO, DTOBITO, "Sexo" = SEXO) %>%
  filter(Sexo %in% c(1, 2)) %>%
  mutate(
    DTNASC = as.character(DTNASC),
    DTNASC = case_when(str_length(DTNASC) == 7 ~ str_c(0, DTNASC),
                       TRUE                    ~ DTNASC),
    DTNASC = parse_date(as.character(DTNASC), format = "%d%m%Y")
  ) %>%
  mutate(
    DTOBITO = as.character(DTOBITO),
    DTOBITO = case_when(str_length(DTOBITO) == 7 ~ str_c(0, DTOBITO),
                        TRUE                     ~ DTOBITO),
    DTOBITO = parse_date(as.character(DTOBITO), format = "%d%m%Y")
  ) %>%
  mutate(Tempo_de_vida = time_length(interval(DTNASC, DTOBITO), 
                                     "days"))    %>%
  drop_na() %>% 
  filter(Tempo_de_vida < 365) %>% 
  mutate(Ano_obito = "2021")


  # Junta os dados de 2019 a 2021
obitos_infantis_2019_2021 <- 
obitos_infantis_2019_2020 %>% 
  bind_rows(obitos_infantis_2021)

  # Calcula a média do período e extrai apenas o resultado
media_obitos_menos_1ano_2019_2021 <-
  obitos_infantis_2019_2021 %>%
  count(Ano_obito) %>%
  summarise(mean(n)) %>%
  pull()
```

```{r}

  # Nascidos vivos em 2020
nascidos_vivos_2020 <- 
dados_sinasc %>% 
  select(DTNASC) %>% 
  mutate(DTNASC = str_sub(DTNASC, -4, -1)) %>% 
  filter(DTNASC == 2020) %>% 
  count(DTNASC) %>% 
  pull(n)

  # Taxa de Mortalidade infantil
TMI_2020 <- media_obitos_menos_1ano_2019_2021 / nascidos_vivos_2020 * 1000
```     

A Taxa de Mortalidade Infantil com média móvel de mortes centrada em 2020 pelo número de nascimentos em 2020 por mil habitantes foi de `r TMI_2020`.

```{r}
# Demais medidas

# 1) Taxa de mortalidade neonatal (entre 0 e 27 dias)

obitos_neonatal <-
  obitos_infantis_2019_2021 %>%
  filter(Tempo_de_vida < 28) %>% # Seleciona o período conforme a taxa de interesse
  count(Ano_obito) %>%
  summarise(mean(n)) %>% 
  pull()
  
TMI_neo_2020 <- obitos_neonatal / nascidos_vivos_2020 * 1000


# 2) Taxa de mortalidade neonatal precoce (entre 0 e 6 dias)

obitos_neonatal_precoce <-
  obitos_infantis_2019_2021 %>%
  filter(Tempo_de_vida < 7) %>%
  count(Ano_obito) %>%
  summarise(mean(n)) %>% 
  pull()
  
TMI_neo_prec_2020 <- obitos_neonatal_precoce / nascidos_vivos_2020 * 1000


# 3) Taxa de mortalidade neonatal tardia (entre 0 e 6 dias)

obitos_neonatal_tardia <- 
  obitos_infantis_2019_2021 %>%
  filter(between(Tempo_de_vida, 7, 27)) %>%
  count(Ano_obito) %>%
  summarise(mean(n)) %>% 
  pull()
  
TMI_neo_tardia_2020 <- obitos_neonatal_tardia / nascidos_vivos_2020 * 1000

# 4) Taxa de mortalidade posneonatal (entre 0 e 27 dias)

obitos_posneonatal <-
  obitos_infantis_2019_2021 %>%
  filter(Tempo_de_vida > 27) %>%
  count(Ano_obito) %>%
  summarise(mean(n)) %>% 
  pull()
  
TMI_posneo_2020 <- obitos_posneonatal / nascidos_vivos_2020 * 1000


```

```{r}
# Como não há dados para óbitos fetais nas tabelas que vêm do pacote Datasus,
# usarei apenas os dados de 2021 para o cálculo

obitos_fetais <- 
dados_sim_2021 %>%
  select(DTNASC, TIPOBITO, DTOBITO, "Sexo" = SEXO) %>%
  filter(Sexo %in% c(1, 2),
         TIPOBITO == 1) %>% # Código para filtrar apenas óbito fetal
  count(TIPOBITO) %>% 
  pull()

TM_perinatal <- 
 (obitos_neonatal_precoce + obitos_fetais) / (nascidos_vivos_2020 + obitos_fetais) * 1000 


```

Os dados para o Estado de Pernambuco são:

```{r}
tibble(Infantil = TMI_2020,
       Neonatal = TMI_neo_2020,
       "Neonatal precoce" = TMI_neo_prec_2020,
       "Neonatal tardia"  = TMI_neo_tardia_2020,
       Posneonatal = TMI_posneo_2020,
       Perinatal = TM_perinatal) %>% 
   kbl(
    format    = "html",
    caption   = "Taxas de mortalidade infantil por mil nascidos vivos", 
    align     = "c", 
    digits    = 3,
    booktabs  = TRUE) %>%
  footnote(
    general  = "Dados de mortalidade infantil em média móvel entre 2019 e 2021 do SIM do Ministério da Saúde. Os dados populacionais são referentes às projeçoes do IGBE para o ano de 2020. Para a contabilidade da Taxa Perinatal, foram somados os dados de óbitos fetais aos dados de nascidos vivos.",
    footnote_as_chunk = TRUE,
    threeparttable    = TRUE
  ) %>%
  kable_styling("striped")
```


